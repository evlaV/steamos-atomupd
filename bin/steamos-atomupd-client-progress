#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright Â© 2020 Collabora Ltd.
#
#  This file is part of steamos-atomupd.
#
#  steamos-atomupd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by the
#  Free Software Foundation; either version 2.1 of the License, or (at your
#  option) any later version.

set -e
set -u

while [[ "$#" -ne 0 ]]
do
    if [[ "$1" =~ ^(-h|--help)$ ]]
    then
        echo "Usage: ${0##*/} [-h|--help] [--exit] [--debug]"
        exit 0
    elif [[ "$1" == "--exit" ]]
    then
        exit=true
    elif [[ "$1" == "--debug" ]]
    then
        debug=true
    else
        echo "$1: Invalid argument" >&2
        exit 1
    fi
    shift
done

while read -r -a words
do
    # Empty line: skip it!
    if [[ "${#words[@]}" -eq 0 ]]
    then
        continue
    fi

    # Print the journal to stderr
    if [[ "${debug:-}" ]]
    then
        echo "${words[@]}" >&2
    fi

    # Slot needs to be updated with /run/rauc/bundle/*.img.caibx
    if [[ "${words[0]}" =~ "Slot" ]]
    then
        slot="${words[6]##*/}"
        slot="${slot%*.img.caibx}"
    # Seeding... ##%
    elif [[ "${words[0]}" =~ "seeding" ]] && [[ "${slot:-}" == "rootfs" ]]
    then
        if [[ "${words[1]}" =~ [0-9]+%$ ]]
        then
            percentage="${words[1]%\%}"
            percentage="$(((percentage*25*90/100)/100))"
            percentage="$((percentage+5))"
            echo "$percentage%"
        fi
    # Downloading chunks ##%
    elif [[ "${words[0]}" == "downloading" ]] && [[ "${slot:-}" == "rootfs" ]]
    then
        if [[ "${words[2]}" =~ [0-9]+%$ ]]
        then
            percentage="${words[2]%\%}"
            percentage="$(((percentage*75*90/100)/100))"
            percentage="$((percentage+5+(25*90/100)))"
            echo "$percentage%"
        fi
    # installing: ...: All slots updated
    elif [[ "${words[0]}" == "installing" ]] &&
         [[ "${words[*]:2}" == "All slots updated" ]]
    then
        percentage="95"
        echo "$percentage%"
    # installing: ...: finished
    elif [[ "${words[0]}" == "installing" ]] &&
         [[ "${words[*]:2}" == "finished" ]]
    then
        percentage="99"
        echo "$percentage%"
    # installing: ...: started
    elif [[ "${words[0]}" == "installing" ]] &&
         [[ "${words[*]:2}" == "started" ]]
    then
        percentage="0"
        echo "$percentage%"
    # installing: ...: failed: ...
    elif [[ "${words[0]}" == "installing" ]] &&
         [[ "${words[*]:2}" =~ "failed: " ]]
    then
        if [[ "${exit:-}" ]]
        then
            exit 0
        fi
    # installing: ...: succeeded
    elif [[ "${words[0]}" == "installing" ]] &&
         [[ "${words[*]:2}" == "succeeded" ]]
    then
        percentage="100"
        echo "$percentage%"
        if [[ "${exit:-}" ]]
        then
            exit 0
        fi
    fi
done < <(journalctl --unit rauc.service --since now --follow --output cat)
